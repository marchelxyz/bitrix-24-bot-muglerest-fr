# Настройка Bitrix24 API для работы с пользовательскими полями

## Проблема
Поля пользователей не заполняются и не возвращаются через API.

## Решение

### 1. Создание пользовательского поля в Bitrix24

**Автоматическое создание (рекомендуется):**
- Бот автоматически создаст поле `UF_USR_TELEGRAM` при первом запуске, если вебхук имеет права `user.userfield.add`

**Ручное создание (если автоматическое не работает):**
1. Войдите в Bitrix24
2. Перейдите: **Настройки** → **Пользователи** → **Пользовательские поля**
3. Нажмите **Добавить поле**
4. Заполните:
   - **Код поля**: `UF_USR_TELEGRAM` (или другое, если настроено через `BITRIX24_TELEGRAM_FIELD_NAME`)
   - **Название**: `Telegram ID` (или любое другое)
   - **Тип поля**: **Строка**
   - **Обязательное**: Нет
   - **Множественное**: Нет
   - **Показывать в списке**: Да
   - **Редактировать в списке**: Да
   - **Доступно для поиска**: Да
5. Сохраните поле

### 2. Настройка прав вебхука

**Необходимые права для вебхука:**
1. Войдите в Bitrix24
2. Перейдите: **Настройки** → **Разработчикам** → **Входящий вебхук**
3. Выберите ваш вебхук (или создайте новый)
4. В разделе **Права доступа** включите:
   - ✅ `user` - для работы с пользователями
   - ✅ `user.update` - для обновления профилей пользователей
   - ✅ `user.userfield` - для работы с пользовательскими полями
   - ✅ `user.userfield.add` - для создания пользовательских полей
   - ✅ `user.userfield.get` - для получения информации о полях
   - ✅ `tasks` - для создания задач (если используется)

**ВАЖНО:** Без этих прав бот не сможет сохранять и получать Telegram ID пользователей.

### 3. Проверка работы API

**Проверка сохранения:**
1. Используйте команду `/link bitrix_user_id` в боте
2. Бот должен сообщить об успешном сохранении
3. Проверьте профиль пользователя в Bitrix24:
   - **Настройки** → **Пользователи** → Откройте профиль пользователя
   - Поле `UF_USR_TELEGRAM` должно содержать ваш Telegram ID

**Проверка получения:**
1. Используйте команду `/check_telegram_id bitrix_user_id`
2. Бот должен показать сохраненный Telegram ID

### 4. Типичные проблемы и решения

**Проблема: Поле не сохраняется**
- **Причина**: Вебхук не имеет прав `user.update` или `user.userfield`
- **Решение**: Проверьте права вебхука (см. пункт 2)

**Проблема: Поле сохраняется, но не возвращается в API**
- **Причина**: Поле не указано в SELECT при запросе
- **Решение**: Код уже исправлен для явного запроса поля через SELECT

**Проблема: Ошибка "Поле не найдено"**
- **Причина**: Поле не создано в Bitrix24
- **Решение**: Создайте поле вручную (см. пункт 1) или проверьте права вебхука для автоматического создания

**Проблема: Ошибка 401 Unauthorized**
- **Причина**: Неправильный токен вебхука или истек срок действия
- **Решение**: Проверьте токен вебхука в переменных окружения и создайте новый вебхук, если нужно

### 5. Формат данных в Bitrix24 API

**Сохранение пользовательского поля:**
```json
{
  "ID": 123,
  "fields": {
    "UF_USR_TELEGRAM": "123456789"
  }
}
```

**Получение пользователя с пользовательским полем:**
```json
{
  "ID": 123,
  "SELECT": ["UF_USR_TELEGRAM"]
}
```

**Поиск пользователя по пользовательскому полю:**
```json
{
  "FILTER": {
    "UF_USR_TELEGRAM": "123456789"
  },
  "SELECT": ["UF_USR_TELEGRAM", "ID"]
}
```

### 6. Дополнительная информация

- Поле создается один раз и становится доступным для всех пользователей
- После создания поле можно использовать для сохранения Telegram ID
- Бот автоматически определяет пользователей по Telegram ID после команды `/link`
- Все связи загружаются из Bitrix24 при запуске бота

## Контакты и поддержка

Если проблема не решена:
1. Проверьте логи бота на наличие ошибок
2. Убедитесь, что все права вебхука включены
3. Проверьте, что поле создано и имеет правильный код
4. Проверьте формат данных в запросах к API
